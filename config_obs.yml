# Workflow to extract and analyse observation data


# This workflow is made to know exactly where to restart if the code is stopped.
# It looks if the result of a task exists in the project catalog before executing the task.
# The workflow does NOT automatically remove intermediate files. You might run out of space.

# List of task to accomplish in the workflow
# Each task will iterate over all simulations before moving on to the next task.
# It might be useful to start by running it once over all tasks on a single simulation
#  (by modifying extract:simulation:search_data_catalogs:other_search_criteria:)
# to make sure all tasks work properly before launching it for all simulations.
tasks:
  #- extract # Extract station data, (gridded observation data), and reanalysis data.
  #- regrid # Regrid the simulation onto a common grid (ERA5-Land).
  #- cleanup # Handle different units in datasets.
  #- indicators # Compute xclim indicators on the datasets.
  #- climatologies # Compute climatological operations for the indicators (mean, std, trend).
  - plotting # Make plots of results from climatological operations for annual, seasonal, and monthly data.
  #- "ensembles" # Compute/compare different datasets and assess uncertainties in historical data (ToDo)

# Task Arguments

extract:  # ------------------------------------- Extraction --------------------------------------------
# reanalysis
  reconstruction:
    dask:
      n_workers: 2
      threads_per_worker: 3
      memory_limit:
        15GB
    search_data_catalogs:
      allow_resampling: False
      allow_conversion: True
      variables_and_freqs: # &var_and_freq # this is an anchor. more on anchors:  https://support.atlassian.com/bitbucket-cloud/docs/yaml-anchors/
        tasmax: D
        tasmin: D
        pr: D
        tas: D
      periods: &ref_period
        #- '1980' #'1989' # defaults to None == extract all available data!
        #- '2018' #'2018'
      other_search_criteria:
        source:
          - ERA5-Land
          - RDRS
    extract_dataset:
      region: &region
        name: Quebec
        method: shape
        tile_buffer: 1.0 #1.5
        shape: /exec/braun/data/obsflow/gis/region_admin.zip!region_admin.shp # shape:shape to create a dictionary (deprecated)
        # shape: /scen3/braun/data/obs_synthese23/gis/lpr_000b16a_e_QC_simpl1.zip!lpr_000b16a_e_QC_simpl1.shp # shape:shape to create a dictionary (deprecated)
    stack_drop_nans: &stack
      False
    save:
      mode: o
      encoding:
        tas: &f32
          dtype: float32
        tasmax: *f32
        tasmin: *f32
        pr: *f32
      rechunk:
        time: -1
        X: 30
        Y: 30

# station observations AHCCD
  station-tas:  # ------------------------------------- Station Temperature -------------------------------------
    dask:
      n_workers: 1
      threads_per_worker: 2
      memory_limit:
        12GB
    search_data_catalogs:
      allow_resampling: False
      allow_conversion: True
      variables_and_freqs:
        tasmax: D
        tasmin: D
        tas: D
        #dtr: D
      periods:
      - '1950' # defaults to None == extract all available data!
      - '2021'
      other_search_criteria:
        source: AHCCD
    extract_dataset:
      region:
        name: Quebec
        method: shape
        tile_buffer: 0
        buffer: 0.03 # needed to capture all QC stations
        shape: /exec/braun/data/obsflow/gis/region_admin.zip!region_admin.shp
        # shape: /scen3/braun/data/obs_synthese23/gis/lpr_000b16a_e_QC_simpl1.zip!lpr_000b16a_e_QC_simpl1.shp
    validation_period:
      miss: "WMO"
      window: 35
      min_years: 25
      freq: "YS"
    xarray_open_kwargs:
      chunks:
        station: 1
    save:
      mode: o
      rechunk:
        time: -1
        station: 50

  station-pr:  # ------------------------------------- Station Precipitation -------------------------------------
    dask:
      n_workers: 1
      threads_per_worker: 2
      memory_limit:
        12GB
    search_data_catalogs:
      allow_resampling: False
      allow_conversion: True
      variables_and_freqs:
        pr: D
      periods:
        - '1950'
        - '2017'
      other_search_criteria:
        source: AHCCD
    extract_dataset:
      region:
        name: Quebec
        method: shape
        tile_buffer: 0
        buffer: 0.03 # needed to capture all QC stations
        shape: /exec/braun/data/obsflow/gis/region_admin.zip!region_admin.shp
        # shape: /scen3/braun/data/obs_synthese23/gis/lpr_000b16a_e_QC_simpl1.zip!lpr_000b16a_e_QC_simpl1.shp
    validation_period:
      miss: "WMO"
      window: 35
      min_years: 25
      freq: "YS"
    xarray_open_kwargs:
      chunks:
        station: 1
    save:
      mode: o
      rechunk:
        time: -1
        station: 50

# simulation MRCC5 -> bcs

#  simulation:
#    dask:
#      n_workers: 2
#      threads_per_worker: 3
#      memory_limit: 10GB
#    search_data_catalogs:
#      #match_hist_and_fut: True
#      allow_resampling: True
#      #allow_conversion: True
#      variables_and_freqs:
#        #pr: D
#        tas: 3H
#      periods: &sim_period
#        - '1979'
#        - '1985'
#      other_search_criteria: # put the simulations you want here
#        code:
#          - bcs
#    extract_dataset:
#      xr_combine_kwargs:
#        combine_attrs: override
#      xr_open_kwargs:
#        drop_variables:
#          - height
#        chunks:
#          lat: 10
#          lon: 10
#          time: 365
#      region: # all
#    # floor: D  # ???
#    save:
#      mode: o
#      encoding:
#        tas: #*f32
#          dtype: float32
#        #pr: *f32
#      rechunk:
#        time: -1
#        X: 40
#        Y: 40

# regrid ---------------------------------------- Regridding -------------------------------------------
regrid:
  dask:
    n_workers: 2
    threads_per_worker: 5
    memory_limit: 10GB
  inputs:
    type: reconstruction
    processing_level: extracted
    source: RDRS
  output:
    type: reconstruction
    processing_level: extracted
    source: ERA5-Land
  regrid_dataset: # this will be automatically passed to the function.
    regridder_kwargs:
      method: nearest_s2d
      extrap_method: inverse_dist
      locstream_out: *stack
      reuse_weights: False
  save: &save_time_-1
    mode: o
    rechunk:
      X: 30
      Y: 30
      time: -1

# cleanup: ---------------------------------------- Cleanup -------------------------------------------
cleanup:
  dask:
    n_workers: 4
    threads_per_worker: 3
    memory_limit: "6GB"
  inputs:
#    variables_and_freqs:
#      tas: D
#      tasmax: D
#      tasmin: D
#      pr: D
#    allow_conversion: True
#    allow_resampling: False
    processing_level: extracted # ToDo: change to regridded!
  xscen_clean_up:
    to_level: extracted-cleaned
    maybe_unstack_dict:
      stack_drop_nans: *stack
      rechunk:
        lat: 30
        lon: 30
        time: -1
    variables_and_units: &units
      tas: degC
      tasmax: degC
      tasmin: degC
      pr: mm d-1
#    convert_calendar_kwargs:
#      target: standard
#      align_on: random
#   missing_by_var:
#      tasmax: interpolate
#      tasmin: interpolate
#      pr: [ 0 ]
  save:
    mode: o
    encoding:
      tas: *f32
      tasmax: *f32
      tasmin: *f32
      pr: *f32



indicators:  # ------------------------------------- Indicators --------------------------------------------------
  dask:
    n_workers: 8
    threads_per_worker: 5
    memory_limit: "8GB"
  inputs:
    processing_level: extracted-cleaned
  ref_percentiles:
    from: 1981-01-01
    to: 2010-12-31
  compute_indicators:
    to_level: indicators
  save: #*save_time_-1
    mode: o
    rechunk:
      time: -1

aggregate:  # ------------------------------------- Climatological Operations -------------------------------------
  dask:
    n_workers: 16
    threads_per_worker: 4
    memory_limit: "15GB"
  periods:
    - ['1951', '1980']
    - ['1961', '1990']
    - ['1961', '2020']
    - ['1971', '2000']
    - ['1981', '2010']
    - ['1981', '2018']
    - ['1988', '2017']
    - ['1991', '2018']
    - ['1991', '2020']
    # - ['1980', '1985']]
  input:
    processing_level: indicators
  vars_for_climatological_mean: # not used for now
  climatological_mean: # automatically passed to the function
    op: mean
    to_level: climatology
  vars_for_interannual_std: &indicators
    - R95pTOT
    - R99pTOT
    - RX1day
    - RX5day
    - days_above_0
    - days_below_m25
    - freeze_thaw_cycles
    - freezing_degree_days_lt_0
    - degree_days_above_0
    #    - frost_free_season_start
    #    - frost_free_season_end
    #    - frost_free_season_length
    - growing_season_length
    - growing_degree_days_gt_5
    - heating_degree_days_lt_15
    - cooling_degree_days_gt_18
    - heat_spell_total_length_class1
    - heat_spell_frequency_class1
    - heat_spell_total_length_class2
    - heat_spell_frequency_class2
    - heat_spell_total_length_class3
    - heat_spell_frequency_class3
    - cold_spell_total_length_class1
    - cold_spell_frequency_class1
    - cold_spell_total_length_class2
    - cold_spell_frequency_class2
    - cold_spell_total_length_class3
    - cold_spell_frequency_class3
    - hot_days_gt_30
    - hot_days_gt_32
    - pr_mean
    - tg_mean
    - tn_mean
    - tn_min
    - tropical_nights_gt_20
    - tropical_nights_gt_22
    - tx_days_below_0
    - tx_mean
    - tx_max
    - dtr
    - dtrmax
  vars_for_climatological_std:
    - pr_std
    - tg_std
    - tn_std
    - tx_std
  climatological_std: # automatically passed to the function
    op: std
    to_level: climatology
  vars_for_climatological_trend: *indicators
  climatological_trend: # automatically passed to the function
    op: linregress
    to_level: climatology
  save:
    mode: o

plotting:  # ------------------------------------- Plotting -------------------------------------
  dask:
    n_workers: 12
    threads_per_worker: 4
    memory_limit: "12GB"
  data:
    processing_level: climatology
  # List of indicators to plot
  indicators:
#    - R95pTOT_clim_linregress
#    - R95pTOT_clim_mean
#    - R95pTOT_clim_std
#    - R99pTOT_clim_linregress
#    - R99pTOT_clim_mean
#    - R99pTOT_clim_std
#    - RX1day_clim_linregress
#    - RX1day_clim_mean
#    - RX1day_clim_std
#    - RX5day_clim_linregress
#    - RX5day_clim_mean
#    - RX5day_clim_std
    - cold_spell_frequency_class1_clim_linregress
    - cold_spell_frequency_class1_clim_mean
    - cold_spell_frequency_class2_clim_linregress
    - cold_spell_frequency_class2_clim_mean
    - cold_spell_frequency_class2_clim_std
    - cold_spell_frequency_class3_clim_linregress
    - cold_spell_frequency_class3_clim_mean
    - cold_spell_frequency_class3_clim_std
    - cold_spell_total_length_class1_clim_linregress
    - cold_spell_total_length_class1_clim_mean
    - cold_spell_total_length_class1_clim_std
    - cold_spell_total_length_class2_clim_linregress
    - cold_spell_total_length_class2_clim_mean
    - cold_spell_total_length_class2_clim_std
    - cold_spell_total_length_class3_clim_linregress
    - cold_spell_total_length_class3_clim_mean
    - cold_spell_total_length_class3_clim_std
#    - cooling_degree_days_gt_18_clim_linregress
#    - cooling_degree_days_gt_18_clim_mean
#    - cooling_degree_days_gt_18_clim_std
#    - days_above_0_clim_linregress
#    - days_above_0_clim_mean
#    - days_above_0_clim_std
#    - days_below_m25_clim_linregress
#    - days_below_m25_clim_mean
#    - days_below_m25_clim_std
#    - degree_days_above_0_clim_linregress
#    - degree_days_above_0_clim_mean
#    - degree_days_above_0_clim_std
#    - dtr_clim_linregress
#    - dtr_clim_mean
#    - dtr_clim_std
#    - dtrmax_clim_linregress
#    - dtrmax_clim_mean
#    - dtrmax_clim_std
#    - freeze_thaw_cycles_clim_linregress
#    - freeze_thaw_cycles_clim_mean
#    - freeze_thaw_cycles_clim_std
#    - freezing_degree_days_lt_0_clim_linregress
#    - freezing_degree_days_lt_0_clim_mean
#    - freezing_degree_days_lt_0_clim_std
#    - growing_degree_days_gt_5_clim_linregress
#    - growing_degree_days_gt_5_clim_mean
#    - growing_degree_days_gt_5_clim_std
    - heat_spell_frequency_class1_clim_linregress
    - heat_spell_frequency_class1_clim_mean
    - heat_spell_frequency_class1_clim_std
    - heat_spell_frequency_class2_clim_linregress
    - heat_spell_frequency_class2_clim_mean
    - heat_spell_frequency_class2_clim_std
    - heat_spell_frequency_class3_clim_linregress
    - heat_spell_frequency_class3_clim_mean
    - heat_spell_frequency_class3_clim_std
    - heat_spell_total_length_class1_clim_linregress
    - heat_spell_total_length_class1_clim_mean
    - heat_spell_total_length_class1_clim_std
    - heat_spell_total_length_class2_clim_linregress
    - heat_spell_total_length_class2_clim_mean
    - heat_spell_total_length_class2_clim_std
    - heat_spell_total_length_class3_clim_linregress
    - heat_spell_total_length_class3_clim_mean
    - heat_spell_total_length_class3_clim_std
#    - heating_degree_days_lt_15_clim_linregress
#    - heating_degree_days_lt_15_clim_mean
#    - heating_degree_days_lt_15_clim_std
#    - hot_days_gt_30_clim_linregress
#    - hot_days_gt_30_clim_mean
#    - hot_days_gt_30_clim_std
#    - hot_days_gt_32_clim_linregress
#    - hot_days_gt_32_clim_mean
#    - hot_days_gt_32_clim_std
#    - pr_mean_clim_linregress
#    - pr_mean_clim_mean
#    - pr_mean_clim_std
#    - pr_std_clim_mean
#    - pr_std_clim_total
#    - tg_mean_clim_linregress
#    - tg_mean_clim_mean
#    - tg_mean_clim_std
#    - tg_std_clim_mean
#    - tg_std_clim_total
#    - tn_mean_clim_linregress
#    - tn_mean_clim_mean
#    - tn_mean_clim_std
#    - tn_min_clim_linregress
#    - tn_min_clim_mean
#    - tn_min_clim_std
#    - tn_std_clim_mean
#    - tn_std_clim_total
#    - tropical_nights_gt_20_clim_linregress
#    - tropical_nights_gt_20_clim_mean
#    - tropical_nights_gt_20_clim_std
#    - tropical_nights_gt_22_clim_linregress
#    - tropical_nights_gt_22_clim_mean
#    - tropical_nights_gt_22_clim_std
#    - tx_days_below_0_clim_linregress
#    - tx_days_below_0_clim_mean
#    - tx_days_below_0_clim_std
#    - tx_max_clim_linregress
#    - tx_max_clim_mean
#    - tx_max_clim_std
#    - tx_mean_clim_linregress
#    - tx_mean_clim_mean
#    - tx_mean_clim_std
#    - tx_std_clim_mean
#    - tx_std_clim_total
  # global plot arguments
  gridmap_kwargs:
    contourf: True
    frame: True
    features:
      states:
        edgecolor: 'dimgray'
        linewidth: 0.3
  # Translate cat:xrfreq to xrfreq_name
  YS-JAN:
    xrfreq_name: year
  YS-JUL:
    xrfreq_name: year
  QS-DEC:
    xrfreq_name: season
  MS:
    xrfreq_name: month
  # frequency specific plotting arguments
  year:
    fig_kwargs:
      figsize: [8, 8]
      gridspec_kw:
        wspace: 0.0
        hspace: 0.0
    plot_kwargs_grid:
      x: lon
      y: lat
      cbar_kwargs:
        shrink: 0.4
        pad: 0.12
      xlim: &xlim
        - -79.5
        - -60
      ylim: &ylim
        - 45
        - 61
    plot_kwargs_station:
      s: 45
    col_wrap:
    suptitle_wrap: 50
    suptitle_kwargs:
      fontsize: 16
      fontweight: bold
      y: 0.98
    subplots_adjust_kwargs:
      left: 0.01
      right: 1.0
      bottom: 0.0
      top: 0.95
      wspace: 0.0
      hspace: 0.0
    legend_kwargs:
      loc: 'lower left'
      fontsize: 12
      bbox_to_anchor: [1.005, 0.05]
      markerscale: 2
      edgecolor: 'dimgray'
      frameon: True
  season:
    fig_kwargs:
      figsize: [10, 9.51]
    plot_kwargs_grid:
      x: lon
      y: lat
      cbar_kwargs:
        shrink: 0.4
        pad: 0.35
      xlim: *xlim
      ylim: *ylim
    plot_kwargs_station:
      s: 20
    col_wrap: 2
    suptitle_wrap: 50
    suptitle_kwargs:
      fontsize: 16
      fontweight: bold
      y: 0.99
    subplots_adjust_kwargs:
      left: 0.01
      right: 0.75
      bottom: 0.01
      top: 0.93
      wspace: 0.0
      hspace: 0.0
    legend_kwargs:
      loc: 'lower left'
      fontsize: 12
      bbox_to_anchor: [1.04, 0.2]
      markerscale: 2
      edgecolor: 'dimgray'
      frameon: True
  month:
    fig_kwargs:
      figsize: [10, 12.41]
    plot_kwargs_grid:
      x: lon
      y: lat
      cbar_kwargs:
        shrink: 0.4
        pad: 0.35
      xlim: *xlim
      ylim: *ylim
    plot_kwargs_station:
      s: 18
    col_wrap: 3
    suptitle_wrap: 50
    suptitle_kwargs:
      fontsize: 16
      fontweight: bold
      y: 0.99
    subplots_adjust_kwargs:
      left: 0.01
      right: .75
      bottom: 0.0
      top: 0.94
      wspace: 0.0
      hspace: 0.0
    legend_kwargs:
      loc: 'lower left'
      fontsize: 12
      bbox_to_anchor: [1.04, .6]
      markerscale: 2
      edgecolor: 'dimgray'
      frameon: True
  # saving figures
  savefig_kwargs:
    dpi: 200
    bbox_inches: tight
    pad_inches: 0.1

# ------------------------------------- Temperature Plots -------------------------------------
  # mean
  tg_mean_clim_mean: &mean
    agg_operation: mean
    label: ''
    limits:
      year:
        vmin: -15
        vmax: 15
      season:
        vmin: -30
        vmax: 30
      month:
        vmin: -30
        vmax: 30
    levels: 21
    ticks: linspace
    units: degC
    divergent: 0
  tn_mean_clim_mean: *mean
  tx_mean_clim_mean: *mean
  # interannual
  tg_mean_clim_std: &std_inter
    agg_operation: std
    label: interannual
    limits:
      year: &vmin_vmax_std_tmp
        vmin: 0
        vmax: 20
      season: *vmin_vmax_std_tmp
      month: *vmin_vmax_std_tmp
    levels: &levels_std_tmp
      [0.0, 0.5, 1.0, 2.0, 3.0, 4.0, 5.0, 7.5, 10.0, 12.5, 15.0, 20.0]
    ticks: *levels_std_tmp
    units: K
    divergent: False
  tn_mean_clim_std: *std_inter
  tx_mean_clim_std: *std_inter
  # intra
  tg_std_clim_mean: &std_intra
    agg_operation: mean
    label: intra
    limits:
      year: *vmin_vmax_std_tmp
      season: *vmin_vmax_std_tmp
      month: *vmin_vmax_std_tmp
    levels: *levels_std_tmp
    ticks: *levels_std_tmp
    units: K
    divergent: False
  tn_std_clim_mean: *std_intra
  tx_std_clim_mean: *std_intra
  # total
  tg_std_clim_total: &std_total
    agg_operation: std
    label: total
    limits:
      year: *vmin_vmax_std_tmp
      season: *vmin_vmax_std_tmp
      month: *vmin_vmax_std_tmp
    levels: *levels_std_tmp
    ticks: *levels_std_tmp
    units: K
    divergent: False
  tn_std_clim_total: *std_total
  tx_std_clim_total: *std_total
  # trend
  tg_mean_clim_linregress: &trend
    agg_operation: linregress
    label: ''
    limits:
      year: &vmin_vmax_trend_tmp
        vmin: -2
        vmax: 2
      season: *vmin_vmax_trend_tmp
      month: *vmin_vmax_trend_tmp
#    levels: 8
#    ticks: [-2, -1.5, -1, -0.5, 0, 0.5, 1, 1.5, 2]
    levels: 9
    ticks: linspace
    units: K
    divergent: True
  tn_mean_clim_linregress: *trend
  tx_mean_clim_linregress: *trend
  # -------------------------------------------- DTR -----------------------------------------------
  dtr_clim_mean:
    agg_operation: mean
    label: ''
    limits:
      year:
        vmin: 5
        vmax: 15
      season:
        vmin: 5
        vmax: 15
      month:
        vmin: 5
        vmax: 15
    levels: 11
    ticks: linspace
    units: K
    divergent: False
  dtr_clim_std:
    agg_operation: std
    label: ''
    limits:
      year:
        vmin: 0
        vmax: 2
      season:
        vmin: 0
        vmax: 2
      month:
        vmin: 0
        vmax: 2
    levels: 9
    ticks: linspace
    units: K
    divergent: False
  dtr_clim_linregress: &dtr_trend
    agg_operation: linregress
    label: ''
    limits:
      year:
        vmin: -0.5
        vmax: 0.5
      season:
        vmin: -0.5
        vmax: 0.5
      month:
        vmin: -0.5
        vmax: 0.5
    levels: 11
    ticks: linspace
    units: K
    divergent:  True
  dtrmax_clim_mean:
    agg_operation: mean
    label: ''
    limits:
      year:
        vmin: 5
        vmax: 25
      season:
        vmin: 5
        vmax: 25
      month:
        vmin: 5
        vmax: 25
    levels: 21
    ticks: linspace
    units: K
    divergent: False
  dtrmax_clim_std:
    agg_operation: std
    label: ''
    limits:
      year:
        vmin: 0
        vmax: 5
      season:
        vmin: 0
        vmax: 5
      month:
        vmin: 0
        vmax: 5
    levels: 11
    ticks: linspace
    units: K
    divergent: False
  dtrmax_clim_linregress: *dtr_trend


  # ------------------------------- Extreme Temperature Indicator Plots -------------------------------------
  days_above_0_clim_linregress: &trend_days_above_0
    label: ''
    limits:
      year: &vmin_vmax_trend_days_above_0
        vmin: -10
        vmax: 10
      season: *vmin_vmax_trend_days_above_0
      month: *vmin_vmax_trend_days_above_0
    levels: 21
    ticks: linspace
    units: days
    divergent: True
  days_above_0_clim_mean: &mean_and_std_days_above_0
    label: ''
    limits:
      year:
        vmin: 50
        vmax: 290
      season:
        vmin: 0
        vmax: 90
      month:
        vmin: 0
        vmax: 30
    levels: 16
    ticks: linspace
    units: days
    divergent: False
  days_above_0_clim_std:
    label: ''
    limits:
      year: &vmin_vmax_std_days_above_0
        vmin: 0
        vmax: 10
      season: *vmin_vmax_std_days_above_0
      month: *vmin_vmax_std_days_above_0
    levels: 21
    ticks: linspace
    units: days
    divergent: False
  days_below_m25_clim_linregress:
    label: ''
    limits:
      year: &vmin_vmax_trend_days_below_m25        # ToDo: Are these good values?
        vmin: -8
        vmax: 8
      season: *vmin_vmax_trend_days_below_m25
      month: *vmin_vmax_trend_days_below_m25
    levels: 17
    ticks: linspace
    units: days
    divergent: True
  days_below_m25_clim_mean: &mean_and_std_days_below_m25
    label: ''
    limits:
      year:
        vmin: 0
        vmax: 90
      season:
        vmin: 0
        vmax: 60
      month:
        vmin: 0
        vmax: 30
    levels: 16
    ticks: linspace
    units: days
    divergent: False
  days_below_m25_clim_std:
    label: ''
    limits:
      year: &vmin_vmax_std_days_below_m25
        vmin: 0
        vmax: 20
      season: *vmin_vmax_std_days_below_m25
      month: *vmin_vmax_std_days_below_m25
    levels: 11
    ticks: linspace
    units: days
    divergent: False
  heat_spell_frequency_class1_clim_linregress: &trend_heat_spell_frequency_all_classes
    label: ''
    limits:
      year: &vmin_vmax_trend_heat_spell_frequency_all_classes
        vmin: -2
        vmax: 2
      season: *vmin_vmax_trend_heat_spell_frequency_all_classes
      month: *vmin_vmax_trend_heat_spell_frequency_all_classes
    levels: 9
    ticks: linspace
    units: days
    divergent: True
  heat_spell_frequency_class1_clim_mean: &mean_and_std_heat_spell_frequency_all_classes
    label: ''
    limits:
      year: &vmin_vmax_mean_heat_spell_frequency_all_classes
        vmin: 0
        vmax: 5
      season: *vmin_vmax_mean_heat_spell_frequency_all_classes
      month: *vmin_vmax_mean_heat_spell_frequency_all_classes
    levels: 11
    ticks: linspace
    units: days
    divergent: False
  heat_spell_frequency_class1_clim_std: *mean_and_std_heat_spell_frequency_all_classes  # ToDo: Are these good values?
  heat_spell_total_length_class1_clim_linregress: &trend_heat_spell_total_length_all_classes
    label: ''
    limits:
      year: &vmin_vmax_trend_heat_spell_total_length_all_classes
        vmin: -2
        vmax: 2
      season: *vmin_vmax_trend_heat_spell_total_length_all_classes
      month: *vmin_vmax_trend_heat_spell_total_length_all_classes
    levels: 9
    ticks: linspace
    units: days
    divergent: True
  heat_spell_total_length_class1_clim_mean: &mean_and_std_heat_spell_total_length_all_classes
    label: ''
    limits:
      year: &vmin_vmax_mean_heat_spell_total_length_all_classes
        vmin: 0
        vmax: 5
      season: *vmin_vmax_mean_heat_spell_total_length_all_classes
      month: *vmin_vmax_mean_heat_spell_total_length_all_classes
    levels: 11
    ticks: linspace
    units: days
    divergent: False
  heat_spell_total_length_class1_clim_std: *mean_and_std_heat_spell_total_length_all_classes
  heat_spell_frequency_class2_clim_linregress: *trend_heat_spell_frequency_all_classes
  heat_spell_frequency_class2_clim_mean: *mean_and_std_heat_spell_frequency_all_classes
  heat_spell_frequency_class2_clim_std: *mean_and_std_heat_spell_frequency_all_classes
  heat_spell_total_length_class2_clim_linregress: *trend_heat_spell_total_length_all_classes
  heat_spell_total_length_class2_clim_mean: *mean_and_std_heat_spell_total_length_all_classes
  heat_spell_total_length_class2_clim_std: *mean_and_std_heat_spell_total_length_all_classes
  heat_spell_frequency_class3_clim_linregress: *trend_heat_spell_frequency_all_classes
  heat_spell_frequency_class3_clim_mean: *mean_and_std_heat_spell_frequency_all_classes
  heat_spell_frequency_class3_clim_std: *mean_and_std_heat_spell_frequency_all_classes
  heat_spell_total_length_class3_clim_linregress: *trend_heat_spell_total_length_all_classes
  heat_spell_total_length_class3_clim_mean: *mean_and_std_heat_spell_total_length_all_classes
  heat_spell_total_length_class3_clim_std: *mean_and_std_heat_spell_total_length_all_classes
  cold_spell_frequency_class1_clim_linregress: &trend_cold_spell_frequency_all_classes
    label: ''
    limits:
      year: &vmin_vmax_trend_cold_spell_frequency_all_classes
        vmin: -2
        vmax: 2
      season: *vmin_vmax_trend_cold_spell_frequency_all_classes
      month: *vmin_vmax_trend_cold_spell_frequency_all_classes
    levels: 9
    ticks: linspace
    units: days
    divergent: True
  cold_spell_frequency_class1_clim_mean: &mean_and_std_cold_spell_frequency_all_classes
    label: ''
    limits:
      year: &vmin_vmax_mean_cold_spell_frequency_all_classes
        vmin: 0
        vmax: 5
      season: *vmin_vmax_mean_cold_spell_frequency_all_classes
      month: *vmin_vmax_mean_cold_spell_frequency_all_classes
    levels: 11
    ticks: linspace
    units: days
    divergent: False
    cold_spell_frequency_class1_clim_std: *mean_and_std_cold_spell_frequency_all_classes  # ToDo: Are these good values?
  cold_spell_total_length_class1_clim_linregress: &trend_cold_spell_total_length_all_classes
    label: ''
    limits:
      year: &vmin_vmax_trend_cold_spell_total_length_all_classes
        vmin: -2
        vmax: 2
      season: *vmin_vmax_trend_cold_spell_total_length_all_classes
      month: *vmin_vmax_trend_cold_spell_total_length_all_classes
    levels: 9
    ticks: linspace
    units: days
    divergent: True
  cold_spell_total_length_class1_clim_mean: &mean_and_std_cold_spell_total_length_all_classes
    label: ''
    limits:
      year: &vmin_vmax_mean_cold_spell_total_length_all_classes
        vmin: 0
        vmax: 5
      season: *vmin_vmax_mean_cold_spell_total_length_all_classes
      month: *vmin_vmax_mean_cold_spell_total_length_all_classes
    levels: 11
    ticks: linspace
    units: days
    divergent: False
  cold_spell_total_length_class1_clim_std: *mean_and_std_cold_spell_total_length_all_classes
  cold_spell_frequency_class2_clim_linregress: *trend_cold_spell_frequency_all_classes
  cold_spell_frequency_class2_clim_mean: *mean_and_std_cold_spell_frequency_all_classes
  cold_spell_frequency_class2_clim_std: *mean_and_std_cold_spell_frequency_all_classes
  cold_spell_total_length_class2_clim_linregress: *trend_cold_spell_total_length_all_classes
  cold_spell_total_length_class2_clim_mean: *mean_and_std_cold_spell_total_length_all_classes
  cold_spell_total_length_class2_clim_std: *mean_and_std_cold_spell_total_length_all_classes
  cold_spell_frequency_class3_clim_linregress: *trend_cold_spell_frequency_all_classes
  cold_spell_frequency_class3_clim_mean: *mean_and_std_cold_spell_frequency_all_classes
  cold_spell_frequency_class3_clim_std: *mean_and_std_cold_spell_frequency_all_classes
  cold_spell_total_length_class3_clim_linregress: *trend_cold_spell_total_length_all_classes
  cold_spell_total_length_class3_clim_mean: *mean_and_std_cold_spell_total_length_all_classes
  cold_spell_total_length_class3_clim_std: *mean_and_std_cold_spell_total_length_all_classes
  hot_days_gt_30_clim_linregress: &trend_hot_days_and_nights_gt_x
    label: ''
    limits:
      year: &vmin_vmax_trend_hot_days_gt_30
        vmin: -5
        vmax: 5
      season: *vmin_vmax_trend_hot_days_gt_30
      month: *vmin_vmax_trend_hot_days_gt_30
    levels: 11
    ticks: linspace
    units: days
    divergent: True
  hot_days_gt_30_clim_mean: &mean_and_std_hot_days_and_nights_gt_x
    label: ''
    limits:
      year: &vmin_vmax_mean_hot_days_gt_30
        vmin: 0
        vmax: 8
      season: *vmin_vmax_mean_hot_days_gt_30
      month: *vmin_vmax_mean_hot_days_gt_30
    levels: 16
    ticks: linspace
    units: days
    divergent: False
  hot_days_gt_30_clim_std: *mean_and_std_hot_days_and_nights_gt_x  # ToDo: Are these good values?
  hot_days_gt_32_clim_linregress: *trend_hot_days_and_nights_gt_x
  hot_days_gt_32_clim_mean: *mean_and_std_hot_days_and_nights_gt_x
  hot_days_gt_32_clim_std: *mean_and_std_hot_days_and_nights_gt_x  # ToDo: Are these good values?
  tropical_nights_gt_20_clim_linregress: *trend_hot_days_and_nights_gt_x
  tropical_nights_gt_20_clim_mean: *mean_and_std_hot_days_and_nights_gt_x
  tropical_nights_gt_20_clim_std: *mean_and_std_hot_days_and_nights_gt_x  # ToDo: Are these good values?
  tropical_nights_gt_22_clim_linregress: *trend_hot_days_and_nights_gt_x
  tropical_nights_gt_22_clim_mean: *mean_and_std_hot_days_and_nights_gt_x
  tropical_nights_gt_22_clim_std: *mean_and_std_hot_days_and_nights_gt_x  # ToDo: Are these good values?
  tx_max_clim_linregress:
    label: ''
    limits:
      year:
        vmin: -5
        vmax: 5
    levels: 11
    ticks: linspace
    units: degC
    divergent: True
  tx_max_clim_mean:
    label: ''
    limits:
      year:
        vmin: 20
        vmax: 35
    levels: 16
    ticks: linspace
    units: degC
    divergent: False
  tx_max_clim_std:
    label: ''
    limits:
      year:
        vmin: 0
        vmax: 5
    levels: 11
    ticks: linspace
    units: degC
    divergent: False
  tn_min_clim_linregress:
    label: ''
    limits:
      year:
        vmin: -5
        vmax: 5
    levels: 11
    ticks: linspace
    units: degC
    divergent: True
  tn_min_clim_mean:
    label: ''
    limits:
      year:
        vmin: -45
        vmax: -25
    levels: 21
    ticks: linspace
    units: degC
    divergent: False
  tn_min_clim_std:
    label: ''
    limits:
      year:
        vmin: 0
        vmax: 5
    levels: 11
    ticks: linspace
    units: degC
    divergent: False

  # -------------------------------- Agro-climatic Indicators Plots -------------------------------------
  freeze_thaw_cycles_clim_linregress:
    label: ''
    limits:
      year: &vmin_vmax_trend_freeze_thaw_cycles
        vmin: -8
        vmax: 8
      season: *vmin_vmax_trend_freeze_thaw_cycles
      month: *vmin_vmax_trend_freeze_thaw_cycles
    levels: 17
    ticks: linspace
    units: days
    divergent: True
  freeze_thaw_cycles_clim_mean: &mean_and_std_freeze_thaw_cycles
    label: ''
    limits:
      year:
        vmin: 0
        vmax: 120
      season:
        vmin: 0
        vmax: 60
      month:
        vmin: 0
        vmax: 30
    levels: 13
    ticks: linspace
    units: days
    divergent: False
  freeze_thaw_cycles_clim_std: *mean_and_std_freeze_thaw_cycles  # ToDo: Are these good values?
  freezing_degree_days_lt_0_clim_linregress:
    label: ''
    limits:
      year: &vmin_vmax_trend_freezing_degree_days_lt_0
        vmin: -500
        vmax: 500
      season: *vmin_vmax_trend_freezing_degree_days_lt_0
      month: *vmin_vmax_trend_freezing_degree_days_lt_0
    levels: 11
    ticks: linspace
    units: ˚C·days
    divergent: True
  freezing_degree_days_lt_0_clim_mean: &mean_and_std_freezing_degree_days_lt_0
    label: ''
    limits:
      year: &vmin_vmax_mean_freezing_degree_days_lt_0
        vmin: 0
        vmax: 5000
      season: *vmin_vmax_mean_freezing_degree_days_lt_0  # FixMe: Can this be removed since there is no seasonal value?
      month: *vmin_vmax_mean_freezing_degree_days_lt_0   # FixMe: Can this be removed since there is no monthly value?
    levels: 21
    ticks: linspace
    units: ˚C·days
    divergent: False
  freezing_degree_days_lt_0_clim_std:
    label: ''
    limits:
      year: &vmin_vmax_std_freezing_degree_days_lt_0
        vmin: 0
        vmax: 500
      season: *vmin_vmax_std_freezing_degree_days_lt_0
      month: *vmin_vmax_std_freezing_degree_days_lt_0
    levels: 21
    ticks: linspace
    units: ˚C·days
    divergent: False
  growing_degree_days_gt_5_clim_linregress:
    label: ''
    limits:
      year: &vmin_vmax_trend_growing_degree_days_gt_4
        vmin: -100
        vmax: 100
      season: *vmin_vmax_trend_growing_degree_days_gt_4   # FixMe: Can this be removed since there is no seasonal value?
      month: *vmin_vmax_trend_growing_degree_days_gt_4
    levels: 21
    ticks: linspace
    units: GDD
    divergent: True
  growing_degree_days_gt_5_clim_mean: &mean_and_std_growing_degree_days_gt_4
    label: ''
    limits:
      year: &vmin_vmax_mean_growing_degree_days_gt_4
        vmin: 0
        vmax: 3000
      season: *vmin_vmax_mean_growing_degree_days_gt_4  # FixMe: Can this be removed since there is no seasonal value?
      month: *vmin_vmax_mean_growing_degree_days_gt_4   # FixMe: Can this be removed since there is no monthly value?
    levels: 17
    ticks: linspace
    units: GDD
    divergent: False
  growing_degree_days_gt_5_clim_std:
    label: ''
    limits:
      year: &vmin_vmax_std_growing_degree_days_gt_4
        vmin: 0
        vmax: 240
      season: *vmin_vmax_std_growing_degree_days_gt_4  # FixMe: Can this be removed since there is no seasonal value?
      month: *vmin_vmax_std_growing_degree_days_gt_4   # FixMe: Can this be removed since there is no monthly value?
    levels: 13
    ticks: linspace
    units: GDD
    divergent: False
  degree_days_above_0_clim_linregress:
    label: ''
    limits:
      year:
        vmin: -100
        vmax: 100
    levels: 21
    ticks: linspace
    units: ˚C·days
    divergent: True
  degree_days_above_0_clim_mean:
    label: ''
    limits:
      year:
        vmin: 0
        vmax: 5000
    levels: 21
    ticks: linspace
    units: ˚C·days
    divergent: False
  degree_days_above_0_clim_std:
    label: ''
    limits:
      year:
        vmin: 0
        vmax: 500
    levels: 11
    ticks: linspace
    units: ˚C·days
    divergent: False
  tx_days_below_0_clim_linregress:
    label: ''
    limits:
      year: &vmin_vmax_trend_tx_days_below_0
        vmin: -10
        vmax: 10
      season: *vmin_vmax_trend_tx_days_below_0
      month: *vmin_vmax_trend_tx_days_below_0
    levels: 21
    ticks: linspace
    units: days
    divergent: True
  tx_days_below_0_clim_mean:
    label: ''
    limits:
      year: &vmin_vmax_mean_tx_days_below_0
        vmin: 0
        vmax: 90
      season: *vmin_vmax_mean_tx_days_below_0
      month: *vmin_vmax_mean_tx_days_below_0
    levels: 16
    ticks: linspace
    units: days
    divergent: False
  tx_days_below_0_clim_std:
    label: ''
    limits:
      year: &vmin_vmax_std_tx_days_below_0
        vmin: 0
        vmax: 10
      season: *vmin_vmax_std_tx_days_below_0
      month: *vmin_vmax_std_tx_days_below_0
    levels: 21
    ticks: linspace
    units: days
    divergent: False

# ------------------------------------- Socio-Economic Indicators -------------------------------------
  heating_degree_days_lt_15_clim_linregress:
    label: ''
    limits:
      year: &vmin_vmax_trend_heating_degree_days_lt_15
        vmin: -500
        vmax: 500
      season: *vmin_vmax_trend_heating_degree_days_lt_15
      month: *vmin_vmax_trend_heating_degree_days_lt_15
    levels: 21
    ticks: linspace
    units: HDD
    divergent: True
  heating_degree_days_lt_15_clim_mean:
    label: ''
    limits:
      year: &vmin_vmax_mean_heating_degree_days_lt_15
        vmin: 0
        vmax: 8000
      season: *vmin_vmax_mean_heating_degree_days_lt_15
      month: *vmin_vmax_mean_heating_degree_days_lt_15
    levels: 17
    ticks: linspace
    units: HDD
    divergent: False
  heating_degree_days_lt_15_clim_std:
    label: ''
    limits:
      year: &vmin_vmax_std_heating_degree_days_lt_15
        vmin: 0
        vmax: 500
      season: *vmin_vmax_std_heating_degree_days_lt_15
      month: *vmin_vmax_std_heating_degree_days_lt_15
    levels: 11
    ticks: linspace
    units: HDD
    divergent: False
  cooling_degree_days_gt_18_clim_linregress:
    label: ''
    limits:
      year: &vmin_vmax_trend_cooling_degree_days_gt_18
        vmin: -500
        vmax: 500
      season: *vmin_vmax_trend_cooling_degree_days_gt_18
      month: *vmin_vmax_trend_cooling_degree_days_gt_18
    levels: 21
    ticks: linspace
    units: CDD
    divergent: True
  cooling_degree_days_gt_18_clim_mean:
    label: ''
    limits:
      year: &vmin_vmax_mean_cooling_degree_days_gt_18
        vmin: 0
        vmax: 3000
      season: *vmin_vmax_mean_cooling_degree_days_gt_18
      month: *vmin_vmax_mean_cooling_degree_days_gt_18
    levels: 13
    ticks: linspace
    units: CDD
    divergent: False
  cooling_degree_days_gt_18_clim_std:
    label: ''
    limits:
      year: &vmin_vmax_std_cooling_degree_days_gt_18
        vmin: 0
        vmax: 200
      season: *vmin_vmax_std_cooling_degree_days_gt_18
      month: *vmin_vmax_std_cooling_degree_days_gt_18
    levels: 11
    ticks: linspace
    units: CDD
    divergent: False

# ------------------------------------- Precipitation Plots -------------------------------------
  # mean
  pr_mean_clim_mean:
    agg_operation: mean
    label: ''
    limits:
      year: &vmin_vmax_mean_pr
        vmin: 0
        vmax: 5
      season: *vmin_vmax_mean_pr
      month: *vmin_vmax_mean_pr
    levels: 21
    ticks: linspace
    units: mm d-1
    divergent: False
  # interannual
  pr_mean_clim_std:
    agg_operation: std
    label: interannual
    limits:
      year: &vmin_vmax_std_pr_inter
        vmin: 0
        vmax: 1
      season: *vmin_vmax_std_pr_inter
      month: *vmin_vmax_std_pr_inter
    levels: &levels_std_pr
      [0.0, 0.25, 0.5, 1.0, 2.0, 3.0, 4.0, 5.0, 7.5, 10.0, 15.0, 20.0, 25.0]
    ticks: &ticks_std_pr
      [0.0, 0.25, 0.5, 1.0, 2.0, 3.0, 4.0, 5.0, 7.5, 10.0, 15.0, 20.0, 25.0]
    units: mm d-1
    divergent: False
  # intra
  pr_std_clim_mean:
    agg_operation: mean
    label: intra
    limits:
      year: &vmin_vmax_std_pr
        vmin: 0
        vmax: 10
      season: *vmin_vmax_std_pr
      month: *vmin_vmax_std_pr
    levels: *levels_std_pr
    ticks: *levels_std_pr
    units: mm d-1
    divergent: False
  # total
  pr_std_clim_total:
    agg_operation: std
    label: total
    limits:
      year: *vmin_vmax_std_pr
      season: *vmin_vmax_std_pr
      month: *vmin_vmax_std_pr
    levels: *levels_std_pr
    ticks: *ticks_std_pr
    units: mm d-1
    divergent: False
  # trend
  pr_mean_clim_linregress:
    agg_operation: linregress
    label: ''
    limits:
      year: &vmin_vmax_trend_pr
        vmin: -1
        vmax: 1
      season: *vmin_vmax_trend_pr
      month: *vmin_vmax_trend_pr
    levels: 9
    ticks: linspace
    units: mm d-1
    divergent: True

# -------------------------------- Extreme Precipitation Indicator Plots -------------------------------------
  R95pTOT_clim_linregress: &trend_RxxpTOT
    label: ''
    limits:
      year: &vmin_vmax_trend_RxxpTOT   # ToDo: Are these good values? if yes, use this for all RxxpTOT
        vmin: -0.12
        vmax: .12
      season: *vmin_vmax_trend_RxxpTOT
      month: *vmin_vmax_trend_RxxpTOT
    levels: 13
    ticks: linspace
    units: 1
    divergent: True
  R95pTOT_clim_mean: &mean_and_std_RxxpTOT
    label: ''
    limits:
      year: &vmin_vmax_mean_RxxpTOT
        vmin: 0
        vmax: .5
      season: *vmin_vmax_mean_RxxpTOT
      month: *vmin_vmax_mean_RxxpTOT
    levels: 11
    ticks: linspace
    units: 1
    divergent: False
  R95pTOT_clim_std: *mean_and_std_RxxpTOT
  R99pTOT_clim_linregress: *trend_RxxpTOT
  R99pTOT_clim_mean: *mean_and_std_RxxpTOT
  R99pTOT_clim_std: *mean_and_std_RxxpTOT  # ToDo: Are these good values?
  RX1day_clim_linregress: &trend_RXxday
    label: ''
    limits:
      year: &vmin_vmax_trend_RXxday       # ToDo: Are these good values?
        vmin: -6
        vmax: 6
      season: *vmin_vmax_trend_RXxday
      month: *vmin_vmax_trend_RXxday
    levels: 13
    ticks: linspace
    units: mm
    divergent: True
  RX1day_clim_mean:
      label: ''
      limits:
        year: &vmin_vmax_mean_RX1day        # ToDo: Are these good values?
          vmin: 0
          vmax: 50
        season: *vmin_vmax_mean_RX1day
        month: *vmin_vmax_mean_RX1day
      levels: 21
      ticks: linspace
      units: mm
      divergent: False
  RX1day_clim_std:
    label: ''
    limits:
      year: &vmin_vmax_std_RX1day
        vmin: 0
        vmax: 20
      season: *vmin_vmax_std_RX1day
      month: *vmin_vmax_std_RX1day
    levels: 21
    ticks: linspace
    units: mm
    divergent: False
  RX5day_clim_linregress:
    label: ''
    limits:
      year: &vmin_vmax_trend_RX5day
        vmin: -10
        vmax: 10
      season: *vmin_vmax_trend_RX5day
      month: *vmin_vmax_trend_RX5day
    levels: 21
    ticks: linspace
    units: mm
    divergent: True
  RX5day_clim_mean: &mean_and_std_RX5day
    label: ''
    limits:
      year: &vmin_vmax_mean_RX5day
        vmin: 0
        vmax: 100
      season: *vmin_vmax_mean_RX5day
      month: *vmin_vmax_mean_RX5day
    levels: 21
    ticks: linspace
    units: mm
    divergent: False
  RX5day_clim_std:
    label: ''
    limits:
      year: &vmin_vmax_std_RX5day
        vmin: 0
        vmax: 40
      season: *vmin_vmax_std_RX5day
      month: *vmin_vmax_std_RX5day
    levels: 21
    ticks: linspace
    units: mm
    divergent: False




#ensembles:
#  dask:
#    n_workers: 3
#    threads_per_worker: 5
#    memory_limit: "5GB"
#  processing_levels:
#    - indicators
#    - climatology
#    - delta
#  ensemble_stats: # automatically passed to the function
#    statistics:
#      ensemble_percentiles: {}
#    stats_kwargs:
#      split: False
#    common_attrs_only: True
#  save:
#    mode: o


# General Arguments

project: # argument to create the project
  name: ObsFlow - A workflow for observation data
  version: 0.3
  description: A xscen workflow for extracting observation data and performing climatic analysis
  id: obsflow

scripting: # send an email when code fails or succeed
  subject: ObsFlow - A workflow for observation data
  send_mail_on_exit:
    msg_err: I crashed, something went wrong!
    on_error_only: True


dask: # general dask arguments
  array.slicing.split_large_chunks: False


logging: # general logging args
  formatters:
    default:
      format: '%(asctime)s %(levelname)-8s %(name)-15s %(message)s'
      datefmt: '%Y-%m-%d %H:%M:%S'
  handlers:
    console:
      class : logging.StreamHandler
      formatter: default
      level : INFO
    file:
      class: logging.FileHandler
      formatter: default
      level : DEBUG
  loggers:
    xscen:
      propagate: False
      level: INFO
      handlers: [file, console]


to_dataset_dict: # parameters to open datasets
  xarray_open_kwargs:
    decode_timedelta: False
